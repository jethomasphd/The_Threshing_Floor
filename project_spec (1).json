{
  "project": {
    "name": "Thresh",
    "full_name": "The Threshing Floor",
    "tagline": "Separate the wheat from the feed.",
    "description": "Thresh is a counter-technology for academic research — a local-first tool that lets graduate researchers query the Reddit API through a guided interface, collect posts and comments, and export documented datasets for dissertation work. Named for the biblical threshing floor, the place where grain is separated from chaff through deliberate labor. In Jacob's mythology: the Feed buries signal under noise. Thresh is the instrument of separation — patient, methodical, revealing what the algorithm obscures. It belongs to the same lineage as The Watchtower and the COMPANION Protocol: tools that honor attention rather than exploit it.",
    "mythological_context": {
      "lineage": "Part of the Corpus of Self counter-technology suite alongside The Watchtower (portfolio tracking) and the COMPANION Protocol (cross-temporal dialogue).",
      "thesis": "The Word against the Feed. Social media platforms bury authentic discourse under algorithmic noise. Thresh gives a researcher the means to reach through the feed and pull out what matters — with full provenance, with methodological rigor, with respect for the people who wrote the words.",
      "metaphor_system": {
        "threshing": "The act of collection and separation — querying Reddit, filtering results, extracting signal.",
        "winnowing": "Analysis and refinement — word frequency, temporal patterns, keyword tracking. The wind that carries away chaff.",
        "gleaning": "Export and documentation — gathering the cleaned grain into bundles ready for use. Every export carries its provenance like a seal.",
        "the_floor": "The workspace itself — the dashboard, the central place of labor."
      }
    },
    "repo_owner": "jacob-e-thomas",
    "license": "MIT",
    "python_version": ">=3.10",
    "target_user": "Graduate student with basic Python literacy, limited web scraping experience, needs IRB-defensible data collection workflows"
  },

  "architecture": {
    "pattern": "monorepo, single deployable",
    "backend": {
      "framework": "FastAPI",
      "server": "uvicorn",
      "orm": "SQLAlchemy + SQLite (local-first, no external DB dependency)",
      "reddit_client": "PRAW (asyncpraw for non-blocking where needed)",
      "task_queue": "background tasks via FastAPI BackgroundTasks (no Celery overhead)"
    },
    "frontend": {
      "approach": "Server-rendered Jinja2 templates + vanilla JS with HTMX for interactivity",
      "rationale": "No build step, no node_modules, grad-student friendly. HTMX gives SPA-like feel without React complexity.",
      "css": "Tailwind CDN for layout utilities, custom CSS for the Thresh design language",
      "charts": "Chart.js for dashboard widgets, Plotly.js for interactive exploration",
      "icons": "Lucide via CDN"
    },
    "storage": {
      "database": "SQLite via SQLAlchemy — stores saved queries, collection jobs, exported datasets metadata",
      "exports": "Local /exports directory with CSV, JSON, JSONL output formats",
      "cache": "SQLite-backed response cache to avoid redundant API calls and respect rate limits"
    }
  },

  "directory_structure": {
    "root": {
      "CLAUDE.md": "Claude Code project instructions and conventions",
      "README.md": "User-facing setup guide and documentation",
      "pyproject.toml": "Project metadata, dependencies, scripts",
      "requirements.txt": "Pinned dependencies for pip users",
      ".env.example": "Template for Reddit API credentials",
      ".gitignore": "Standard Python + SQLite + exports ignores",
      "app/": {
        "__init__.py": "FastAPI app factory",
        "main.py": "App entry point, mount routes",
        "config.py": "Settings via pydantic-settings, loads .env",
        "models/": {
          "__init__.py": "",
          "database.py": "SQLAlchemy engine, session, Base",
          "schemas.py": "Pydantic models for API request/response validation",
          "tables.py": "SQLAlchemy ORM models (SavedQuery, CollectionJob, ExportRecord)"
        },
        "services/": {
          "__init__.py": "",
          "reddit_client.py": "PRAW wrapper — authenticated client, rate-limit-aware methods",
          "collector.py": "Data collection logic — subreddit pulls, search, comment trees",
          "exporter.py": "Export to CSV, JSON, JSONL with provenance headers",
          "cache.py": "Response caching layer to minimize API calls",
          "analyzer.py": "Text stats, word frequency, temporal distribution (the winnowing)"
        },
        "routes/": {
          "__init__.py": "",
          "pages.py": "Jinja2 page routes (floor, explore, thresh, harvest, winnow, glean, about)",
          "api.py": "JSON API endpoints for HTMX partials and async operations"
        },
        "templates/": {
          "base.html": "Layout shell — nav, footer, HTMX + Tailwind CDN, design language",
          "pages/": {
            "floor.html": "The Floor (dashboard) — recent activity, quick-start, saved queries",
            "explore.html": "Explore — subreddit search, preview, metadata",
            "thresh.html": "Thresh (collect) — configure and run data pulls",
            "harvest.html": "Harvest (results) — view collected data, filter, basic stats",
            "winnow.html": "Winnow (analyze) — word frequency, temporal patterns, keyword tracking",
            "glean.html": "Glean (export) — format selection, download, provenance notes",
            "about.html": "About — documentation, citation guide, ethical considerations, mythology"
          },
          "partials/": {
            "post_card.html": "Single post display component",
            "comment_tree.html": "Recursive comment thread display",
            "stats_panel.html": "Quick statistics sidebar",
            "query_form.html": "Reusable search/filter form",
            "loading.html": "HTMX loading indicator (threshing animation)",
            "toast.html": "Notification component",
            "provenance_badge.html": "Data provenance indicator on all displayed results"
          }
        },
        "static/": {
          "css/": { "thresh.css": "Design language — dark palette, ember gold, typography, sigils" },
          "js/": {
            "thresh.js": "Global utilities, HTMX config, toast handler",
            "charts.js": "Chart.js initialization with Thresh color palette",
            "export.js": "Client-side export preview and download triggers"
          },
          "img/": {
            "sigil.svg": "Thresh sigil mark — threshing floor glyph",
            "favicon.svg": "Browser tab icon"
          }
        }
      },
      "tests/": {
        "conftest.py": "Shared fixtures — mock PRAW client, test DB",
        "test_reddit_client.py": "PRAW wrapper unit tests",
        "test_collector.py": "Collection logic tests with mocked responses",
        "test_exporter.py": "Export format validation tests",
        "test_routes.py": "Route integration tests"
      },
      "scripts/": {
        "seed_demo.py": "Populate DB with sample data for development",
        "validate_credentials.py": "Quick check that .env Reddit creds work"
      },
      "exports/": {
        ".gitkeep": "Empty dir for exported datasets"
      }
    }
  },

  "navigation_map": {
    "description": "Pages named from the threshing metaphor. Nav uses both the metaphor name and a plain descriptor so the student never feels lost.",
    "items": [
      { "route": "/", "label": "The Floor", "subtitle": "Dashboard", "icon": "layout-dashboard" },
      { "route": "/explore", "label": "Explore", "subtitle": "Find Subreddits", "icon": "compass" },
      { "route": "/thresh", "label": "Thresh", "subtitle": "Collect Data", "icon": "wheat" },
      { "route": "/harvest", "label": "Harvest", "subtitle": "View Results", "icon": "package" },
      { "route": "/winnow", "label": "Winnow", "subtitle": "Analyze", "icon": "wind" },
      { "route": "/glean", "label": "Glean", "subtitle": "Export", "icon": "download" },
      { "route": "/about", "label": "About", "subtitle": "Documentation", "icon": "book-open" }
    ]
  },

  "features": {
    "phase_1_core": {
      "priority": "MUST HAVE — build these first",
      "items": [
        {
          "name": "Credential Setup Flow",
          "description": "First-run experience walks user through creating Reddit app credentials and storing them in .env. Validates credentials on save. Warm, guided tone — she is being welcomed to the floor.",
          "acceptance": "User enters client_id, client_secret, user_agent and sees confirmation that API access is live."
        },
        {
          "name": "Subreddit Explorer",
          "description": "Search subreddits by name/topic, view metadata (subscribers, description, rules, post frequency), preview recent posts.",
          "acceptance": "User types a topic, sees matching subreddits with key stats, can click into any to preview recent posts."
        },
        {
          "name": "Thresh (Post Collection)",
          "description": "Pull posts from a subreddit by sort method (hot/new/top with time filters), keyword search, or global Reddit search. Configure: max posts, include comments (depth control), date range.",
          "acceptance": "User configures a pull, sees a threshing progress indicator, gets a preview table of collected posts."
        },
        {
          "name": "Harvest (Data Preview & Stats)",
          "description": "View collected data in sortable/filterable table. Sidebar: total posts, date range, avg score, avg comments, top authors, posting frequency chart.",
          "acceptance": "Collected data renders in responsive table with at least 3 chart widgets showing temporal and engagement patterns."
        },
        {
          "name": "Glean (Export Pipeline)",
          "description": "Export collected data to CSV, JSON, or JSONL. Each export includes provenance.txt sidecar documenting: query parameters, date collected, API version, subreddit(s), filters applied.",
          "acceptance": "User downloads ZIP containing data file + provenance.txt. CSV opens cleanly in Excel/pandas."
        }
      ]
    },
    "phase_2_research": {
      "priority": "SHOULD HAVE — enhances research utility",
      "items": [
        {
          "name": "Comment Tree Collection",
          "description": "Expand and collect full comment trees with configurable depth. Flatten to tabular format with parent_id references preserved.",
          "acceptance": "User pulls all comments for a post, sees threaded view, exports flat CSV with parent_id linkage."
        },
        {
          "name": "Saved Queries",
          "description": "Save collection configurations for re-running. Name, describe, tag queries. Re-run with one click to extend longitudinal datasets.",
          "acceptance": "User saves a query, sees it on The Floor, can re-run and append new data."
        },
        {
          "name": "Winnow — Temporal Analysis",
          "description": "Interactive timeline of post/comment volume over time. Overlay events, filter by keyword. Identify activity spikes.",
          "acceptance": "Plotly.js timeline with brushable zoom, keyword highlight overlay, export of visible date range."
        },
        {
          "name": "Winnow — Word Frequency & Keywords",
          "description": "Word frequency distributions, keyword co-occurrence, ngram viewer. Pure Python, no ML dependencies.",
          "acceptance": "Top-50 terms (stopwords removed), bigram frequencies, specific term trends over time."
        }
      ]
    },
    "phase_3_polish": {
      "priority": "NICE TO HAVE — quality of life",
      "items": [
        {
          "name": "Collection Job Queue",
          "description": "Background job system for long-running pulls. Progress animation, estimated time, cancel ability.",
          "acceptance": "User starts 10k-post pull, sees live progress, can navigate away and return."
        },
        {
          "name": "Provenance Report Generator",
          "description": "Auto-generate formatted methodology section for dissertation methods chapter.",
          "acceptance": "User downloads .md file with dissertation-ready prose describing data collection."
        },
        {
          "name": "Rate Limit Sentinel",
          "description": "Visual API usage display. Ember-gold gauge that dims as quota depletes.",
          "acceptance": "Sidebar widget shows requests used/remaining with countdown to reset."
        }
      ]
    }
  },

  "design_system": {
    "philosophy": "This is a Jacob E. Thomas artifact. Same lineage as The Watchtower and the COMPANION Dossier: dark ground, ember gold accents, intentional typography, ritualistic composure. But it also serves a graduate student who didn't sign up for mysticism — the aesthetic is atmospheric, not opaque. The metaphors orient; the interface clarifies.",
    "color_palette": {
      "ground": "#0A0A0F",
      "surface": "#131318",
      "surface_raised": "#1A1A22",
      "ember": "#C9A227",
      "ember_dim": "#8B7121",
      "ember_glow": "#E8C547",
      "ash": "#6B6B7B",
      "smoke": "#3D3D4A",
      "bone": "#E8E4DC",
      "bone_muted": "#A8A49C",
      "success": "#4A9B6E",
      "warning": "#D4943A",
      "error": "#C44B4B",
      "link": "#7BA3C9",
      "link_hover": "#A8C8E8"
    },
    "typography": {
      "display_font": "Cormorant Garamond (Google Fonts) — the ritual voice, page titles and sigil mark",
      "body_font": "IBM Plex Sans (Google Fonts) — the working voice, clear and humane",
      "mono_font": "IBM Plex Mono (Google Fonts) — the data voice, tables, code, API output",
      "scale": {
        "base": "16px",
        "body_line_height": "1.6",
        "heading_line_height": "1.15",
        "display_sizes": "clamp(2rem, 4vw, 3.5rem) for page titles",
        "body_sizes": "0.875rem compact, 1rem reading, 0.8125rem table data"
      }
    },
    "visual_language": {
      "sigil": "The Thresh mark — stylized threshing floor glyph (circle with crossed grain stalks). Appears in nav header, loading states, export watermark. SVG, ember gold on dark ground.",
      "borders": "1px solid rgba(201, 162, 39, 0.15) — ember gold at low opacity",
      "dividers": "Thin rules in smoke color. Key section breaks use ember gold at 30% opacity.",
      "shadows": "Minimal. When used: 0 4px 24px rgba(0, 0, 0, 0.5) — deep and diffuse",
      "radius": "4px inputs/buttons, 8px cards, 2px table cells",
      "glow_effects": "Ember gold glow on active/focus: box-shadow: 0 0 0 2px rgba(201, 162, 39, 0.3)",
      "noise_texture": "CSS grain overlay at 2-3% opacity on ground bg",
      "scrollbar": "Thin, smoke track, ember thumb on hover"
    },
    "components": {
      "cards": "surface bg, 1px ember-tinted border, 8px radius. Hover: border brightens to ember_dim.",
      "buttons": {
        "primary": "ember bg, ground text, ember glow on hover",
        "secondary": "transparent bg, 1px ember_dim border, bone text. Hover: fill smoke.",
        "ghost": "No border, bone_muted text. Hover: brightens to bone."
      },
      "tables": "surface bg, smoke row dividers, bone_muted header (uppercase, 0.75rem, tracked). Data in IBM Plex Mono. Alternating: surface / surface_raised.",
      "forms": {
        "inputs": "surface_raised bg, 1px smoke border, bone text, 4px radius. Focus: ember glow ring.",
        "labels": "bone_muted, IBM Plex Sans, 0.8125rem, uppercase tracked.",
        "validation": "Error: error color below input. Success: success checkmark inline."
      },
      "navigation": {
        "sidebar": "ground bg, fixed left. Active: ember left border (3px), ember text, surface_raised bg.",
        "mobile": "Bottom tab bar, icons only at small breakpoints.",
        "header": "Thresh sigil + 'The Threshing Floor' in Cormorant Garamond, ember gold."
      },
      "empty_states": "Centered: sigil at 40% opacity, Cormorant heading, Plex Sans description, primary CTA.",
      "loading": {
        "skeleton": "surface_raised pulsing blocks with smoke shimmer",
        "spinner": "Rotating sigil mark, ember gold, subtle pulse",
        "progress": "Thin bar, ember fill on smoke track, percentage in mono"
      },
      "toasts": "surface_raised bg, 3px left border colored by type. Slide from top-right, dismiss 4s."
    }
  },

  "technical_constraints": {
    "no_external_db": "SQLite only",
    "no_build_step": "No webpack, no npm, no node_modules. CDN only.",
    "no_docker_required": "pip install + python main.py",
    "rate_limit_respect": "Never exceed 100 req/min. Surface quota to user.",
    "reproducibility": "Every export includes full provenance metadata.",
    "privacy_conscious": "No stored passwords. Re-identification warnings. Ethics in About page.",
    "offline_capable": "Preview/analysis/export work without internet after collection."
  },

  "dependencies": {
    "core": [
      "fastapi>=0.110.0",
      "uvicorn[standard]>=0.27.0",
      "praw>=7.7.0",
      "sqlalchemy>=2.0.0",
      "pydantic>=2.0.0",
      "pydantic-settings>=2.0.0",
      "jinja2>=3.1.0",
      "python-multipart>=0.0.6",
      "python-dotenv>=1.0.0",
      "aiofiles>=23.0.0"
    ],
    "data": ["pandas>=2.1.0", "openpyxl>=3.1.0"],
    "analysis": ["nltk>=3.8.0"],
    "dev": ["pytest>=7.4.0", "pytest-asyncio>=0.23.0", "httpx>=0.25.0", "ruff>=0.1.0"],
    "frontend_cdn": [
      "htmx.org@1.9.x",
      "tailwindcss@3.x (CDN play)",
      "chart.js@4.x",
      "plotly.js@2.x (basic bundle)",
      "lucide@latest (icons)"
    ]
  },

  "agent_work_packages": {
    "packages": [
      { "id": "WP-01", "name": "Lay the Floor", "scope": "Directory structure, pyproject.toml, requirements.txt, .env.example, .gitignore, config.py, database.py, app factory, main.py. Verify: uvicorn starts.", "depends_on": [] },
      { "id": "WP-02", "name": "The Hands (Reddit Client)", "scope": "PRAW wrapper — init, subreddit search, post retrieval, comment trees, rate limit tracking. Unit tests with mocked PRAW.", "depends_on": ["WP-01"] },
      { "id": "WP-03", "name": "The Bones (Templates & Design Language)", "scope": "base.html, nav sidebar, thresh.css (full dark palette, ember gold, typography, glow, noise texture), fonts, CDN includes, responsive shell. Floor page placeholder. Sigil SVG.", "depends_on": ["WP-01"] },
      { "id": "WP-04", "name": "Explore", "scope": "Explore page — search, HTMX results, subreddit cards, post preview click-through.", "depends_on": ["WP-02", "WP-03"] },
      { "id": "WP-05", "name": "Thresh (Collection)", "scope": "Collector service, config form, background tasks, progress polling, SQLite storage, threshing animation.", "depends_on": ["WP-02", "WP-03"] },
      { "id": "WP-06", "name": "Harvest (Results)", "scope": "Harvest page — data table (Plex Mono), stats sidebar (Chart.js), comment tree partial. Thresh palette.", "depends_on": ["WP-05"] },
      { "id": "WP-07", "name": "Glean (Export)", "scope": "Exporter service, format config, ZIP with provenance.txt, download endpoint.", "depends_on": ["WP-05"] },
      { "id": "WP-08", "name": "Welcome to the Floor", "scope": "First-run detection, credential wizard, validation, .env writing. About page with docs + mythology.", "depends_on": ["WP-02", "WP-03"] },
      { "id": "WP-09", "name": "The Floor (Dashboard)", "scope": "SavedQuery model, save/load/re-run, dashboard with recent activity and quick-start.", "depends_on": ["WP-05", "WP-06"] },
      { "id": "WP-10", "name": "Winnow (Analysis)", "scope": "Word frequency, ngrams, temporal keywords. Analyzer service + Plotly.js in Thresh design.", "depends_on": ["WP-06"] }
    ]
  }
}
