{% extends "base.html" %}
{% block title %}The Floor — Dashboard | Thresh{% endblock %}
{% block content %}
<div class="page-header">
  <h1 class="page-title">The Floor</h1>
  <p class="page-subtitle">Your workspace — recent activity, saved queries, quick start</p>
</div>

{% if not has_activity %}
<!-- ============================================================ -->
<!-- Welcome banner — shown when no activity exists yet            -->
<!-- ============================================================ -->
<div class="empty-state">
  <img src="/static/img/sigil.svg" alt="" class="empty-state-sigil">
  <h2 class="empty-state-heading">Welcome to the Threshing Floor</h2>
  <p class="empty-state-text">
    The floor is where the work begins. Explore subreddits, configure your first
    data collection, and build defensible datasets — all from here. No setup needed.
  </p>
  <div class="flex flex-wrap items-center justify-center gap-3 mt-2">
    <a href="/explore" class="btn btn-primary btn-lg">
      <i data-lucide="compass" style="width:18px;height:18px;"></i>
      Explore Subreddits
    </a>
  </div>
</div>

{% else %}
<!-- ============================================================ -->
<!-- Dashboard — shown when there is activity                      -->
<!-- ============================================================ -->

<!-- Quick Actions row -->
<div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
  <a href="/thresh" class="quick-action-card card">
    <div class="flex items-center gap-3">
      <div class="quick-action-icon">
        <i data-lucide="wheat" style="width:24px;height:24px;"></i>
      </div>
      <div>
        <h4 class="font-body font-medium text-bone" style="font-size:0.9375rem;">New Collection</h4>
        <p class="text-xs text-ash mt-0.5 mb-0">Configure and run a data collection</p>
      </div>
    </div>
  </a>

  <a href="/explore" class="quick-action-card card">
    <div class="flex items-center gap-3">
      <div class="quick-action-icon">
        <i data-lucide="compass" style="width:24px;height:24px;"></i>
      </div>
      <div>
        <h4 class="font-body font-medium text-bone" style="font-size:0.9375rem;">Explore Subreddits</h4>
        <p class="text-xs text-ash mt-0.5 mb-0">Scout the field before harvest</p>
      </div>
    </div>
  </a>

  <a href="/glean" class="quick-action-card card">
    <div class="flex items-center gap-3">
      <div class="quick-action-icon">
        <i data-lucide="download" style="width:24px;height:24px;"></i>
      </div>
      <div>
        <h4 class="font-body font-medium text-bone" style="font-size:0.9375rem;">Export Data</h4>
        <p class="text-xs text-ash mt-0.5 mb-0">Bundle and document your datasets</p>
      </div>
    </div>
  </a>
</div>

<!-- Main content: 2-column layout -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

  <!-- Left column (2/3 width) -->
  <div class="lg:col-span-2 flex flex-col gap-6">

    <!-- Recent Collections card -->
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Recent Collections</h3>
        <div class="flex items-center gap-2">
          <a href="/thresh" class="text-xs text-link hover:text-link-hover">View All</a>
        </div>
      </div>
      <div class="card-body" id="dashboard-recent-jobs">
        {% if recent_jobs %}
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>Subreddit</th>
                <th>Status</th>
                <th>Posts</th>
                <th>Comments</th>
                <th>Date</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for job in recent_jobs %}
              <tr>
                <td>
                  <span class="text-ember font-mono">r/{{ job.subreddit }}</span>
                </td>
                <td>
                  {% if job.status == 'completed' %}
                    <span class="badge badge-success">completed</span>
                  {% elif job.status == 'running' %}
                    <span class="badge badge-warning">running</span>
                  {% elif job.status == 'pending' %}
                    <span class="badge badge-ash">pending</span>
                  {% elif job.status == 'failed' %}
                    <span class="badge badge-error">failed</span>
                  {% endif %}
                </td>
                <td><span class="font-mono">{{ job.collected_posts }}</span></td>
                <td><span class="font-mono">{{ job.collected_comments }}</span></td>
                <td>
                  <span class="text-bone-muted text-xs">
                    {% if job.started_at %}
                      {{ job.started_at.strftime('%b %d, %Y') }}
                    {% elif job.completed_at %}
                      {{ job.completed_at.strftime('%b %d, %Y') }}
                    {% else %}
                      --
                    {% endif %}
                  </span>
                </td>
                <td>
                  {% if job.status == 'completed' %}
                  <a href="/harvest?job_id={{ job.id }}" class="btn btn-ghost btn-sm" title="View in Harvest">
                    <i data-lucide="eye" style="width:14px;height:14px;"></i>
                  </a>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="text-center py-8">
          <img src="/static/img/sigil.svg" alt="" class="mx-auto mb-3 opacity-30" width="48" height="48">
          <p class="text-bone-muted text-sm">No collections yet.</p>
          <p class="text-ash text-xs mt-1">
            <a href="/thresh" class="text-link">Start your first collection</a> to see activity here.
          </p>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Recent Exports card -->
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Recent Exports</h3>
        <a href="/glean" class="text-xs text-link hover:text-link-hover">View All</a>
      </div>
      <div class="card-body" id="dashboard-recent-exports">
        {% if recent_exports %}
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>Collection</th>
                <th>Format</th>
                <th>Records</th>
                <th>Date</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for export in recent_exports %}
              <tr>
                <td>
                  {% if export.job_id in export_jobs %}
                    <span class="text-ember font-mono">r/{{ export_jobs[export.job_id].subreddit }}</span>
                  {% else %}
                    <span class="text-ash font-mono">Job #{{ export.job_id }}</span>
                  {% endif %}
                </td>
                <td>
                  <span class="tag">{{ export.format | upper }}</span>
                </td>
                <td><span class="font-mono">{{ export.record_count }}</span></td>
                <td>
                  <span class="text-bone-muted text-xs">
                    {{ export.exported_at.strftime('%b %d, %Y') }}
                  </span>
                </td>
                <td>
                  <a href="/api/exports/{{ export.id }}/download" class="btn btn-ghost btn-sm" title="Download" download>
                    <i data-lucide="download" style="width:14px;height:14px;"></i>
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="text-center py-8">
          <img src="/static/img/sigil.svg" alt="" class="mx-auto mb-3 opacity-30" width="48" height="48">
          <p class="text-bone-muted text-sm">No exports yet.</p>
          <p class="text-ash text-xs mt-1">
            Collect data first, then <a href="/glean" class="text-link">export it</a> with full provenance.
          </p>
        </div>
        {% endif %}
      </div>
    </div>

  </div>

  <!-- Right column (1/3 width): Saved Queries -->
  <div class="flex flex-col gap-6">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Saved Queries</h3>
        <button
          class="btn btn-ghost btn-sm"
          hx-get="/api/queries"
          hx-target="#saved-queries-list"
          hx-swap="innerHTML"
          title="Refresh saved queries"
        >
          <i data-lucide="refresh-cw" style="width:14px;height:14px;"></i>
        </button>
      </div>
      <div class="card-body" id="saved-queries-list">
        {% if saved_queries %}
          {% for query in saved_queries %}
            {% include "partials/saved_query_card.html" %}
          {% endfor %}
        {% else %}
        <div class="text-center py-8">
          <img src="/static/img/sigil.svg" alt="" class="mx-auto mb-3 opacity-30" width="48" height="48">
          <p class="text-bone-muted text-sm">No saved queries yet.</p>
          <p class="text-ash text-xs mt-1">
            Save your first collection configuration from the
            <a href="/thresh" class="text-link">Thresh</a> page.
          </p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

</div>
{% endif %}

{% endblock %}
