{% extends "base.html" %}
{% block title %}Thresh — Collect Data | The Threshing Floor{% endblock %}
{% block content %}
<div class="page-header">
  <h1 class="page-title">Thresh</h1>
  <p class="page-subtitle">Beat the grain — configure and run your data collection</p>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

  <!-- Left column: Collection form + progress area -->
  <div class="lg:col-span-2 flex flex-col gap-6">

    <!-- Collection configuration card -->
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Collection Configuration</h3>
        <span class="badge badge-ember">
          <i data-lucide="settings" style="width:14px;height:14px;"></i>
          Configure
        </span>
      </div>
      <div class="card-body">
        {% include "partials/collection_form.html" %}
      </div>
    </div>

    <!-- Progress / results area — HTMX swaps collection status here -->
    <div id="collection-progress">
      <!-- Empty initially. When a collection starts, the job progress
           partial is swapped in here via HTMX. -->
    </div>
  </div>

  <!-- Right column: Recent jobs panel -->
  <div class="flex flex-col gap-6">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Recent Collections</h3>
        <button
          class="btn btn-ghost btn-sm"
          hx-get="/api/collect/recent"
          hx-target="#recent-jobs-list"
          hx-swap="innerHTML"
          title="Refresh recent jobs"
        >
          <i data-lucide="refresh-cw" style="width:14px;height:14px;"></i>
        </button>
      </div>
      <div class="card-body" id="recent-jobs-list">
        {% if recent_jobs %}
          {% for job in recent_jobs %}
            {% include "partials/job_card.html" %}
          {% endfor %}
        {% else %}
          <div class="text-center py-8">
            <img src="/static/img/sigil.svg" alt="" class="mx-auto mb-3 opacity-30" width="48" height="48">
            <p class="text-bone-muted text-sm">No collections yet.</p>
            <p class="text-ash text-xs mt-1">Configure your first collection to begin.</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script defer>
  // Toggle comment options visibility based on checkbox
  document.addEventListener('DOMContentLoaded', function() {
    const includeComments = document.getElementById('include_comments');
    const commentOptions = document.getElementById('comment-options');

    if (includeComments && commentOptions) {
      function toggleCommentOptions() {
        if (includeComments.checked) {
          commentOptions.style.display = 'block';
        } else {
          commentOptions.style.display = 'none';
        }
      }
      includeComments.addEventListener('change', toggleCommentOptions);
      toggleCommentOptions();
    }

    // Toggle time_filter visibility based on sort method
    const sortSelect = document.getElementById('sort');
    const timeFilterGroup = document.getElementById('time-filter-group');

    if (sortSelect && timeFilterGroup) {
      function toggleTimeFilter() {
        const needsTime = ['top', 'controversial'].includes(sortSelect.value);
        timeFilterGroup.style.display = needsTime ? 'block' : 'none';
      }
      sortSelect.addEventListener('change', toggleTimeFilter);
      toggleTimeFilter();
    }
  });

  // Re-initialize after HTMX swaps (for dynamically loaded forms)
  document.body.addEventListener('htmx:afterSwap', function(evt) {
    const includeComments = document.getElementById('include_comments');
    const commentOptions = document.getElementById('comment-options');
    if (includeComments && commentOptions) {
      if (!includeComments.checked) {
        commentOptions.style.display = 'none';
      }
    }
  });
</script>
{% endblock %}
